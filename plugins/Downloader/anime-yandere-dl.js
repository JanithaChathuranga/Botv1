// Klo mau pake, pake aja ini bkn enc cma terser aja

import cheerio from"cheerio";import fetch from"node-fetch";import{lookup}from"mime-types";import{URL_REGEX}from"@whiskeysockets/baileys";let handler=async(m,{conn:conn,text:text,usedPrefix:usedPrefix,command:command})=>{if(!(text=text.endsWith("SMH")?text.replace("SMH",""):text))throw"Input Query / yande.re Url";let[query,page]=text.split(" "),res=await getYandeImage(query,page);if("in_progress"===res)return void await conn.sendMessage(m.chat,"Fetching image. Please wait...","conversation",{quoted:m});let mime=await lookup(res);text.match(URL_REGEX)?await conn.sendMessage(m.chat,{[mime.split("/")[0]]:{url:res},caption:`Success Download: ${await shortUrl(res)}`},{quoted:m}):await conn.sendMessage(m.chat,{image:{url:res},caption:`Result From: ${text.capitalize()}`},{quoted:m})};handler.help=handler.alias=["yandere","yande"].map((v=>v+" <query> [page]")),handler.tags=["downloader"],handler.command=/^(yandere|yande)$/i;export default handler;async function getYandeImage(query,page=""){if(query.match(URL_REGEX)){let res=await fetch(query),html=await res.text(),image=cheerio.load(html)("img").attr("src");if(!image)throw"Can't fetch image :/";return image}{let apiUrl=`https://yande.re/post.json?tags=${query}`;if(page){const pageNumber=parseInt(page);!isNaN(pageNumber)&&pageNumber>0&&(apiUrl+=`&page=${pageNumber}`)}await new Promise((resolve=>setTimeout(resolve,2e3)));let res=await fetch(apiUrl),json=await res.json();if(0===json.length)throw`Query "${query}" not found :/`;let data=json[~~(Math.random()*json.length)];if(!data)throw`Query "${query}" not found :/`;return data.file_url}}async function shortUrl(url){return await(await fetch(`https://tinyurl.com/api-create.php?url=${url}`)).text()}