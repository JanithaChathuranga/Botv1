// Klo mau pake, pake aja ini bkn enc cma terser aja

import canvafy from"canvafy";import{promises as fsPromises}from"fs";import{createHash}from"crypto";import fetch from"node-fetch";let Reg=/\|?(.*)([^\w\s])([0-9]*)$/i,handler=async(m,{conn:conn,usedPrefix:usedPrefix,command:command,text:text})=>{if(conn.registrasi=conn.registrasi||{},conn.registrasi[m.chat])return conn.reply(m.chat,"Anda masih berada dalam sesi Registrasi",conn.registrasi[m.chat].msg);let user=global.db.data.users[m.sender];if(!0===user.registered)throw`[💬] Kamu sudah terdaftar\nMau daftar ulang? *${usedPrefix}unreg <SERIAL NUMBER>*`;const umurRandom=Math.floor(100*Math.random())+1,formatSalah=`⚠️ Format salah\n\n✳️ Penggunaan perintah : *${usedPrefix+command} nama.umur*\n📌Contoh : *${usedPrefix+command}* ${m.sender.split("@")[0]}.${umurRandom}`;if(!Reg.test(text))throw formatSalah;let[_,name,splitter,age]=text.match(Reg);if(!name)throw"Nama tidak boleh kosong (Alphanumeric)";if(!age)throw"Umur tidak boleh kosong (Angka)";if(age=parseInt(age),age>30)throw"*Gak boleh!*,\nTua amat dah 🗿";if(age<5)throw"*Gak boleh!*,\nBanyak pedo 🗿";if(user.name&&user.name.trim()===name.trim())throw"Nama sudah dipakai";try{let sn=createHash("md5").update(m.sender).digest("hex"),who=m.mentionedJid&&m.mentionedJid[0]?m.mentionedJid[0]:m.quoted?m.quoted.sender:m.fromMe?conn.user.jid:m.sender,pp=await conn.profilePictureUrl(who,"image").catch((_=>logo)),caption=`\n*VERIFIKASI BERHASIL*\n\n• *Nama:* ${name}\n• *Umur:* ${age} tahun\n• *Serial Number (SN):* ${sn}\n\nTerima kasih telah melakukan verifikasi. Data pengguna telah disimpan dengan aman di database bot. Data kamu sekarang sudah terverifikasi.\n\n🚀 Sekarang kamu dapat menggunakan fitur-fitur khusus yang hanya tersedia untuk pengguna terverifikasi.\n`;const json=await createOtpCanvas(pp);let confirm="💡 Reply pesan ini dengan mengetik kode OTP yang ada pada gambar!",txt=`📝 *Registrasi* 📝\n\n@${m.sender.split("@")[0]}\n${confirm}\n\n_( Berlaku 1X )_`,msg=await conn.sendMessage(m.chat,{image:json.image,caption:txt,mentions:[m.sender]},{quoted:m});conn.registrasi[m.chat]={OTP:json.otp,VERIFIED:json.verified,CAPTION:caption,MSG:msg,NAME:name,AGE:age,timeout:setTimeout((()=>{conn.sendMessage(m.chat,{delete:msg.key}),delete conn.registrasi[m.chat]}),6e4)}}catch(e){console.log(e),await m.reply(eror)}};handler.help=["daftar","register"].map((v=>v+" <nama>.<umur>")),handler.tags=["xp"],handler.command=/^(register|verify|daftar|reg(is)?|verif)$/i;export default handler;function pickRandom(list){return list[Math.floor(Math.random()*list.length)]}function isNumber(x){return!isNaN(x)}function generateRandomCharacter(){const characters="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";return characters[Math.floor(62*Math.random())]}async function createOtpCanvas(avatar){const codetext=Array.from({length:4},generateRandomCharacter).join("");return{image:await(new canvafy.Captcha).setBackground("image","https://cdn.discordapp.com/attachments/1087030211813593190/1110243947311288530/beeautiful-sunset-illustration-1212023.webp").setCaptchaKey(codetext.toString()).setBorder("#f0f0f0").setOverlayOpacity(.7).build(),otp:codetext,verified:await(new canvafy.Security).setAvatar(avatar).setBackground("image","https://cdn.discordapp.com/attachments/1087030211813593190/1110243947311288530/beeautiful-sunset-illustration-1212023.webp").setCreatedTimestamp(Date.now()).setSuspectTimestamp(1).setBorder("#f0f0f0").setLocale("id").setAvatarBorder("#f0f0f0").setOverlayOpacity(.9).build()}}